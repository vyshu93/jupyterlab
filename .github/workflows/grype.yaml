# .github/workflows/grype.yaml
name: üì¶ DevSecOps - Dependency Scan (Grype SCA)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  grype_scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: ‚¨áÔ∏è Install Grype CLI (To Global Path)
        # Install Grype directly to /usr/local/bin which is guaranteed to be in the PATH
        # FIX: Specify the version (v0.97.1) to avoid calling the failing /latest API
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sudo sh -s -- -b /usr/local/bin v0.97.1
          grype version # Verify installation
          
      - name: Run Grype scan (table output)
        run: grype . -o table --add-cpes-if-none


      - name: üîé Run Grype Scan (No Failure)
        # The scan will run, generate the report, and exit successfully (code 0), 
        # regardless of the number or severity of vulnerabilities found.
        run: grype dir:. -o json --file grype-report.json
        
      - name: üì§ Print Grype Report Content
        run: |
          echo "--- START GRYPE REPORT ---"
          cat grype-report.json
          echo "--- END GRYPE REPORT ---"
          
      - name: ‚¨ÜÔ∏è Upload Grype Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: grype-security-report
          path: grype-report.json